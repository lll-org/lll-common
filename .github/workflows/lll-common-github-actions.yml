name: lll-common-github-actions
on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch: {}



env:
  JAVA_VERSION: 21

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'
          # 关键：这个 server-id 要和 pom.xml 里的 distributionManagement 的 <id> 一致
          server-id: 'nexus'
          # 这俩是“环境变量名”，不是 secrets 名
          server-username: NEXUS_USERNAME
          server-password: NEXUS_PASSWORD



      - name: Generate Maven settings.xml (use Nexus for downloading + deploying)
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings>
            <mirrors>
              <mirror>
                <id>nexus-mirror</id>
                <mirrorOf>*</mirrorOf>
                <url>https://nexus.lll44556.top/repository/maven-public/</url>
              </mirror>
            </mirrors>
          
            <servers>
              <server>
                <id>nexus</id>
                <username>${env.NEXUS_USERNAME}</username>
                <password>${env.NEXUS_PASSWORD}</password>
              </server>
            </servers>
          
            <profiles>
              <profile>
                <id>use-nexus</id>
                <repositories>
                  <repository>
                    <id>nexus-public</id>
                    <url>https://nexus.lll44556.top/repository/maven-public/</url>
                    <releases><enabled>true</enabled></releases>
                    <snapshots><enabled>true</enabled></snapshots>
                  </repository>
                </repositories>
                <pluginRepositories>
                  <pluginRepository>
                    <id>nexus-public</id>
                    <url>https://nexus.lll44556.top/repository/maven-public/</url>
                    <releases><enabled>true</enabled></releases>
                    <snapshots><enabled>true</enabled></snapshots>
                  </pluginRepository>
                </pluginRepositories>
              </profile>
            </profiles>
          
            <activeProfiles>
              <activeProfile>use-nexus</activeProfile>
            </activeProfiles>
          </settings>
          EOF
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}

      - name: Build & Deploy to Nexus
        run: mvn -B -ntp -DskipTests clean deploy
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}














      - name: Build & Deploy to Nexus
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          mvn -B -ntp -DskipTests clean deploy
